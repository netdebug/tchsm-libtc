#include <stdlib.h>
#include <string.h>

#include "algorithms.h"

#define OCTET_SIZE(z) ((mpz_sizeinbase(z, 2) + 7) / 8)

const byte MD2_PKCS_ID[] = {
    0x30, 0x20, 0x30, 0x0C, 0x06, 0x08, 0x2A, 0x86, 0x48, 0x86,
    0xF7, 0x0D, 0x02, 0x02, 0x05, 0x00, 0x04, 0x10 };

const byte MD5_PKCS_ID[] = {
    0x30, 0x20, 0x30, 0x0C, 0x06, 0x08, 0x2A, 0x86, 0x48, 0x86,
    0xF7, 0x0D, 0x02, 0x05, 0x05, 0x00, 0x04, 0x10 };

const byte RIPEMD_128_PKCS_ID[] = {
    0x30, 0x21, 0x30, 0x09, 0x06, 0x05, 0x2B, 0x24, 0x03, 0x02,
    0x02, 0x05, 0x00, 0x04, 0x14 };

const byte RIPEMD_160_PKCS_ID[] = {
    0x30, 0x21, 0x30, 0x09, 0x06, 0x05, 0x2B, 0x24, 0x03, 0x02,
    0x01, 0x05, 0x00, 0x04, 0x14 };

const byte SHA_160_PKCS_ID[] = {
    0x30, 0x21, 0x30, 0x09, 0x06, 0x05, 0x2B, 0x0E, 0x03, 0x02,
    0x1A, 0x05, 0x00, 0x04, 0x14 };

const byte SHA_224_PKCS_ID[] = {
    0x30, 0x2D, 0x30, 0x0D, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
    0x65, 0x03, 0x04, 0x02, 0x04, 0x05, 0x00, 0x04, 0x1C };

const byte SHA_256_PKCS_ID[] = {
    0x30, 0x31, 0x30, 0x0D, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
    0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x04, 0x20 };

const byte SHA_384_PKCS_ID[] = {
    0x30, 0x41, 0x30, 0x0D, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
    0x65, 0x03, 0x04, 0x02, 0x02, 0x05, 0x00, 0x04, 0x30 };

const byte SHA_512_PKCS_ID[] = {
    0x30, 0x51, 0x30, 0x0D, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
    0x65, 0x03, 0x04, 0x02, 0x03, 0x05, 0x00, 0x04, 0x40 };

const byte TIGER_PKCS_ID[] = {
    0x30, 0x29, 0x30, 0x0D, 0x06, 0x09, 0x2B, 0x06, 0x01, 0x04,
    0x01, 0xDA, 0x47, 0x0C, 0x02, 0x05, 0x00, 0x04, 0x18 };

static const byte * get_hash_id(int * len, const char * hash_str) {
    if (!strcmp(hash_str, "SHA-256")) {
        *len = sizeof(SHA_256_PKCS_ID);
        return SHA_256_PKCS_ID;
    } else if (!strcmp(hash_str, "SHA-512")) {
        *len = sizeof(SHA_512_PKCS_ID);
        return SHA_512_PKCS_ID;
    } else if (!strcmp(hash_str, "NONE")) {
        *len = 0;
        return NULL;
    } else { /* ERROR! */
        abort();
    }
}

byte * pkcs1_encoding(mpz_t signature, char * hash, public_key_t const * pk) {
    int digest_len = OCTET_SIZE(signature);
    int k = OCTET_SIZE(pk->n);
    int hash_desc_len;
    const byte * hash_desc = get_hash_id(&hash_desc_len, hash);

    int D_len = hash_desc_len + digest_len;

    int P_len = k - 3 - D_len;
    byte * p = malloc(k);

    *p++ = 0x00;
    *p++ = 0x01;
    memset(&p[2], 0xFF, P_len);
    p += P_len;
    *p++ = 0x00;

    if (hash_desc != NULL) {
        memcpy(p, hash_desc, hash_desc_len);
        p += hash_desc_len;
    }

    size_t len;
    mpz_export(p, &len, 1, 1, 0, 0, signature);

    return p;
}
